{"version":3,"file":"index.modern.js","sources":["../src/AuthContext.tsx","../src/AuthProvider.tsx","../src/pkce.ts","../src/util.ts","../src/AuthService.ts"],"sourcesContent":["import React, { useContext, ReactElement } from 'react'\n\nimport { AuthServiceProps, AuthService } from './AuthService'\n\nexport type AuthContextProps = {\n  authService: AuthService\n}\n\nexport type AuthContextType = AuthContextProps | undefined\n\nexport const AuthContext = React.createContext<AuthContextProps | undefined>(\n  undefined\n)\n\nexport const useAuth = (): AuthContextProps => {\n  const context = useContext(AuthContext)\n  if (context === undefined) {\n    throw new Error('useAuth must be used within a AuthProvider')\n  }\n  return context\n}\n\nexport function withAuth<T>(\n  ComponentToWrap: React.ComponentType<T & AuthServiceProps>\n): React.FC<T & AuthServiceProps> {\n  const WrappedComponent = (props: T & AuthServiceProps): ReactElement => {\n    const authProps = useAuth()\n    return <ComponentToWrap {...authProps} {...props} />\n  }\n  WrappedComponent.displayName =\n    'withAuth_' + (ComponentToWrap.displayName || ComponentToWrap.name)\n  return WrappedComponent\n}\n","import React, { ReactElement, ReactNode } from 'react'\n\nimport { AuthService } from './AuthService'\nimport { AuthContext } from './AuthContext'\n\ninterface AuthProviderProps {\n  children: ReactNode\n  authService: AuthService\n}\n\nexport const AuthProvider = (props: AuthProviderProps): ReactElement => {\n  const { authService, children } = props\n\n  return (\n    <AuthContext.Provider value={{ authService }}>\n      {children}\n    </AuthContext.Provider>\n  )\n}\n","import { randomBytes, createHash } from 'crypto'\n\nexport type PKCECodePair = {\n  codeVerifier: string\n  codeChallenge: string\n  createdAt: Date\n}\n\nexport const base64URLEncode = (str: Buffer): string => {\n  return str\n    .toString('base64')\n    .replace(/\\+/g, '-')\n    .replace(/\\//g, '_')\n    .replace(/=/g, '')\n}\n\nexport const sha256 = (buffer: Buffer): Buffer => {\n  return createHash('sha256').update(buffer).digest()\n}\n\nexport const createPKCECodes = (): PKCECodePair => {\n  const codeVerifier = base64URLEncode(randomBytes(64))\n  const codeChallenge = base64URLEncode(sha256(Buffer.from(codeVerifier)))\n  const createdAt = new Date()\n  const codePair = {\n    codeVerifier,\n    codeChallenge,\n    createdAt\n  }\n  return codePair\n}\n","export const toSnakeCase = (str: string): string => {\n  return str\n    .split(/(?=[A-Z])/)\n    .join('_')\n    .toLowerCase()\n}\n\nexport const toUrlEncoded = (obj: {}): string => {\n  return Object.keys(obj)\n    .map(\n      (k) =>\n        encodeURIComponent(toSnakeCase(k)) + '=' + encodeURIComponent(obj[k])\n    )\n    .join('&')\n}\n","import { createPKCECodes, PKCECodePair } from './pkce'\nimport { toUrlEncoded } from './util'\n\nimport jwtDecode from 'jwt-decode'\n\nexport interface AuthServiceProps {\n  clientId: string\n  clientSecret?: string\n  contentType?: string\n  location: Location\n  provider: string\n  redirectUri?: string\n  scopes: string[]\n  autoRefresh?: boolean\n  refreshSlack?: number\n}\n\nexport interface AuthTokens {\n  id_token: string\n  access_token: string\n  refresh_token: string\n  expires_in: number\n  token_type: string\n}\n\nexport interface JWTIDToken {\n  given_name: string\n  family_name: string\n  name: string\n  email: string\n}\n\nexport interface TokenRequestBody {\n  clientId: string\n  grantType: string\n  redirectUri?: string\n  refresh_token?: string\n  clientSecret?: string\n  code?: string\n  codeVerifier?: string\n}\n\nexport class AuthService<TIDToken = JWTIDToken> {\n  props: AuthServiceProps\n\n  constructor(props: AuthServiceProps) {\n    this.props = props\n    const code = this.getCodeFromLocation(window.location)\n    if (code !== null) {\n      this.fetchToken(code)\n        .then(() => {\n          this.restoreUri()\n        })\n        .catch((e) => {\n          this.removeItem('pkce')\n          this.removeItem('auth')\n          this.removeCodeFromLocation()\n          console.warn({ e })\n        })\n    } else if (this.props.autoRefresh) {\n      this.startTimer()\n    }\n  }\n\n  getUser(): {} {\n    const t = this.getAuthTokens()\n    if (null === t) return {}\n    const decoded = jwtDecode(t.id_token) as TIDToken\n    return decoded\n  }\n\n  getCodeFromLocation(location: Location): string | null {\n    const split = location.toString().split('?')\n    if (split.length < 2) {\n      return null\n    }\n    const pairs = split[1].split('&')\n    for (const pair of pairs) {\n      const [key, value] = pair.split('=')\n      if (key === 'code') {\n        return decodeURIComponent(value || '')\n      }\n    }\n    return null\n  }\n\n  removeCodeFromLocation(): void {\n    const [base, search] = window.location.href.split('?')\n    if (!search) {\n      return\n    }\n    const newSearch = search\n      .split('&')\n      .map((param) => param.split('='))\n      .filter(([key]) => key !== 'code')\n      .map((keyAndVal) => keyAndVal.join('='))\n      .join('&')\n    window.history.replaceState(\n      window.history.state,\n      'null',\n      base + (newSearch.length ? `?${newSearch}` : '')\n    )\n  }\n\n  getItem(key: string): string | null {\n    return window.localStorage.getItem(key)\n  }\n  removeItem(key: string): void {\n    window.localStorage.removeItem(key)\n  }\n\n  getPkce(): PKCECodePair {\n    const pkce = window.localStorage.getItem('pkce')\n    if (null === pkce) {\n      throw new Error('PKCE pair not found in local storage')\n    } else {\n      return JSON.parse(pkce)\n    }\n  }\n  setAuthTokens(auth: AuthTokens): void {\n    window.localStorage.setItem('auth', JSON.stringify(auth))\n  }\n\n  getAuthTokens(): AuthTokens {\n    return JSON.parse(window.localStorage.getItem('auth') || '{}')\n  }\n\n  isPending(): boolean {\n    return (\n      window.localStorage.getItem('pkce') !== null &&\n      window.localStorage.getItem('auth') === null\n    )\n  }\n\n  isAuthenticated(): boolean {\n    return window.localStorage.getItem('auth') !== null\n  }\n\n  async logout(): Promise<boolean> {\n    this.removeItem('pkce')\n    this.removeItem('auth')\n    window.location.reload()\n    return true\n  }\n\n  async login(): Promise<void> {\n    this.authorize()\n  }\n\n  // this will do a full page reload and to to the OAuth2 provider's login page and then redirect back to redirectUri\n  authorize(): boolean {\n    const { clientId, provider, redirectUri, scopes } = this.props\n\n    const pkce = createPKCECodes()\n    window.localStorage.setItem('pkce', JSON.stringify(pkce))\n    window.localStorage.setItem('preAuthUri', location.href)\n    window.localStorage.removeItem('auth')\n    const codeChallenge = pkce.codeChallenge\n\n    const query = {\n      clientId,\n      scopes: scopes.join(' '),\n      responseType: 'code',\n      redirectUri,\n      codeChallenge,\n      codeChallengeMethod: 'S256'\n    }\n    // Responds with a 302 redirect\n    const url = `${provider}/authorize?${toUrlEncoded(query)}`\n    window.location.replace(url)\n    return true\n  }\n\n  // this happens after a full page reload. Read the code from localstorage\n  async fetchToken(code: string, isRefresh = false): Promise<AuthTokens> {\n    const {\n      clientId,\n      clientSecret,\n      contentType,\n      provider,\n      redirectUri,\n      autoRefresh = false\n    } = this.props\n    const grantType = 'authorization_code'\n\n    let payload: TokenRequestBody = {\n      clientId,\n      ...(clientSecret ? { clientSecret } : {}),\n      redirectUri,\n      grantType\n    }\n    if (isRefresh) {\n      payload = {\n        ...payload,\n        grantType: 'refresh_token',\n        // eslint-disable-next-line @typescript-eslint/camelcase\n        refresh_token: code\n      }\n    } else {\n      const pkce: PKCECodePair = this.getPkce()\n      const codeVerifier = pkce.codeVerifier\n      payload = {\n        ...payload,\n        code,\n        codeVerifier\n      }\n    }\n\n    const response = await fetch(`${provider}/token`, {\n      headers: {\n        'Content-Type': contentType || 'application/x-www-form-urlencoded'\n      },\n      method: 'POST',\n      body: toUrlEncoded(payload)\n    })\n    this.removeItem('pkce')\n    const json = await response.json()\n    this.setAuthTokens(json as AuthTokens)\n    console.log(autoRefresh)\n    if (autoRefresh) {\n      this.startTimer()\n    }\n    return json\n  }\n\n  armRefreshTimer(refreshToken: string, timeoutDuration: number) {\n    const { refreshSlack = 10 } = this.props\n    window.setTimeout(() => {\n      this.fetchToken(refreshToken, true)\n        .then(({ refresh_token: newRefreshToken, expires_in: expiresIn }) => {\n          const now = new Date().getTime()\n          const expiresAt = now + (expiresIn - refreshSlack) * 1000\n          const timeout = expiresAt - now\n          if (timeout > 0) {\n            this.armRefreshTimer(newRefreshToken, timeout)\n          } else {\n            this.removeItem('auth')\n            this.removeCodeFromLocation()\n          }\n        })\n        .catch((e) => {\n          this.removeItem('auth')\n          this.removeCodeFromLocation()\n          console.warn({ e })\n        })\n    }, timeoutDuration)\n  }\n\n  startTimer(): void {\n    const { refreshSlack = 10 } = this.props\n    const authTokens = this.getAuthTokens()\n    if (!authTokens) {\n      return\n    }\n    const { refresh_token: refreshToken, expires_in: expiresIn } = authTokens\n    if (!expiresIn || !refreshToken) {\n      return\n    }\n    const now = new Date().getTime()\n    const expiresAt = now + (expiresIn - refreshSlack) * 1000\n    const timeout = expiresAt - now\n    if (timeout > 0) {\n      this.armRefreshTimer(refreshToken, timeout)\n    } else {\n      this.removeItem('auth')\n      this.removeCodeFromLocation()\n    }\n  }\n\n  restoreUri(): void {\n    const uri = window.localStorage.getItem('preAuthUri')\n    window.localStorage.removeItem('preAuthUri')\n    console.log({ uri })\n    if (uri !== null) {\n      window.location.replace(uri)\n    }\n    this.removeCodeFromLocation()\n  }\n}\n"],"names":["AuthContext","React","createContext","undefined","useAuth","context","useContext","Error","withAuth","ComponentToWrap","WrappedComponent","props","authProps","displayName","name","AuthProvider","authService","children","Provider","value","base64URLEncode","str","toString","replace","sha256","buffer","createHash","update","digest","createPKCECodes","codeVerifier","randomBytes","codeChallenge","Buffer","from","createdAt","Date","codePair","toSnakeCase","split","join","toLowerCase","toUrlEncoded","obj","Object","keys","map","k","encodeURIComponent","AuthService","code","getCodeFromLocation","window","location","fetchToken","then","restoreUri","e","removeItem","removeCodeFromLocation","console","warn","autoRefresh","startTimer","getUser","t","getAuthTokens","decoded","jwtDecode","id_token","length","pairs","pair","key","decodeURIComponent","href","base","search","newSearch","param","filter","keyAndVal","history","replaceState","state","getItem","localStorage","getPkce","pkce","JSON","parse","setAuthTokens","auth","setItem","stringify","isPending","isAuthenticated","logout","reload","login","authorize","clientId","provider","redirectUri","scopes","query","responseType","codeChallengeMethod","url","isRefresh","clientSecret","contentType","grantType","payload","refresh_token","fetch","headers","method","body","response","json","log","armRefreshTimer","refreshToken","timeoutDuration","refreshSlack","setTimeout","newRefreshToken","expiresIn","expires_in","now","getTime","expiresAt","timeout","authTokens","uri"],"mappings":"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"}